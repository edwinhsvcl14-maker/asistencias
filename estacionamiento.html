<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parking Pro - Sistema de Estacionamiento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define la fuente Inter */
        html { font-family: 'Inter', sans-serif; }

        /* Colores tem√°ticos de Parking/Seguridad */
        .bg-park-primary { background-color: #2563EB; } /* Azul Intenso */
        .text-park-primary { color: #2563EB; }
        .hover\:bg-park-secondary:hover { background-color: #3B82F6; } /* Azul m√°s claro */

        /* Animaci√≥n de Carga para el Logo */
        @keyframes spinner-grow {
            0%, 100% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1); opacity: 1; }
        }
        .logo-loader {
            animation: spinner-grow 1.5s ease-in-out infinite;
        }

        /* Estilo para el SVG del Coche/Logo */
        .car-logo {
            width: 80px;
            height: 80px;
        }

        /* Estilos de Tarjeta de Plaza */
        .parking-spot {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .parking-spot:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app">
        <div class="flex items-center justify-center min-h-screen"><div class="text-xl font-semibold text-park-primary">Iniciando Sistema...</div></div>
    </div>

    <script>
        // Funci√≥n Auto-Ejecutable (IIFE) para asegurar un scope limpio y privado.
        (function() {
            "use strict";

            // --- FUNCI√ìN DE INICIALIZACI√ìN Y PARSING DE DATOS ---
            let USERS = [];
            let PARKING_SPOTS = [];
            const SIMULATED_DELAY = 500; // 500ms de retraso para simular la carga de datos.

            // SVG del Coche (Logo) - Usado para Login y Loading
            const CAR_LOGO_SVG = '
                <svg class="car-logo text-park-primary logo-loader" viewBox="0 0 100 100" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                    <rect x="25" y="10" width="50" height="80" rx="10" ry="10" fill="none" stroke="currentColor" stroke-width="5"/>
                    <rect x="35" y="20" width="30" height="40" fill="currentColor" opacity="0.1"/>
                    <circle cx="35" cy="80" r="7" fill="currentColor"/>
                    <circle cx="65" cy="80" r="7" fill="currentColor"/>
                    <circle cx="35" cy="20" r="7" fill="currentColor"/>
                    <circle cx="65" cy="20" r="7" fill="currentColor"/>
                    <path d="M50 5 L50 95" stroke="currentColor" stroke-width="2" stroke-dasharray="5 5" opacity="0.5"/>
                </svg>
            ';

            try {
                // Datos de prueba (JSON simulado) - REVISI√ìN CR√çTICA DE COMAS Y LLAVES AQU√ç
                const USERS_JSON = '[{"user":"admin","pass":"admin123","name":"Administrador General","role":"admin"},{"user":"worker1","pass":"parker1","name":"Operario Turno Ma√±ana","role":"worker"},{"user":"worker2","pass":"parker2","name":"Operario Turno Tarde","role":"worker"}]';
                
                // Datos de estacionamiento (Plazas - 'Spots')
                const PARKING_SPOTS_JSON = '[
                        {"id":"A01","status":"Occupied","plate":"LMA-123","entryTime":"2025-11-25T10:00:00","carType":"Sedan"},
                        {"id":"A02","status":"Available"},
                        {"id":"A03","status":"Available"},
                        {"id":"A04","status":"Occupied","plate":"PQR-456","entryTime":"2025-11-25T14:30:00","carType":"Truck"},
                        {"id":"B01","status":"Available"},
                        {"id":"B02","status":"Occupied","plate":"XYZ-789","entryTime":"2025-11-25T11:45:00","carType":"SUV"},
                        {"id":"B03","status":"Available"},
                        {"id":"B04","status":"Available"} 
                ]';

                USERS = JSON.parse(USERS_JSON);
                PARKING_SPOTS = JSON.parse(PARKING_SPOTS_JSON);
                console.log("DIAGN√ìSTICO: Datos de usuarios y estacionamientos cargados.");
                
            } catch (error) {
                console.error("ERROR CR√çTICO: Fall√≥ el parseo de datos JSON:", error);
                const appContainer = document.getElementById('app');
                appContainer.innerHTML = `<div class="flex items-center justify-center min-h-screen p-4"><div class="p-8 text-center text-red-700 bg-red-100 rounded-lg shadow-xl"><h2>Error Cr√≠tico de Datos</h2><p>La aplicaci√≥n fall√≥ al cargar los datos: ${error.message}</p></div></div>`;
                return;
            }
            
            // Declaraciones de configuraci√≥n y estado
            const MENU_CONFIG = {
                'admin': [
                    { id: 'dashboard', label: 'Dashboard', icon: 'üè†' },
                    { id: 'parking_map', label: 'Mapa de Plazas', icon: 'üó∫Ô∏è' },
                    { id: 'register_entry', label: 'Registrar Ingreso', icon: '‚¨ÜÔ∏è' },
                    { id: 'admin_reports', label: 'Reportes y Cierres', icon: 'üìä' },
                ],
                'worker': [
                    { id: 'parking_map', label: 'Mapa de Plazas', icon: 'üó∫Ô∏è' },
                    { id: 'register_entry', label: 'Registrar Ingreso', icon: '‚¨ÜÔ∏è' },
                    { id: 'register_exit', label: 'Registrar Salida', icon: '‚¨áÔ∏è' },
                ]
            };

            let currentUser = null;
            let currentPage = 'parking_map'; // La vista de mapa es la m√°s importante
            let selectedSpot = null; // Para manejo de entrada/salida

            const getAppContainer = () => document.getElementById('app');

            // --- FUNCI√ìN CENTRALIZADA DE CARGA ---

            function toggleLoading(show, message = 'Procesando...') {
                const overlay = document.getElementById('loading-overlay');
                const msgElement = document.getElementById('loading-message');

                if (overlay) {
                    if (show) {
                        overlay.classList.remove('hidden');
                        if (msgElement) {
                            msgElement.innerHTML ='
                                <div class="flex flex-col items-center space-y-4">
                                    ${CAR_LOGO_SVG.replace('logo-loader', 'logo-loader')}
                                    <p class="text-lg font-semibold text-park-primary">${message}</p>
                                    <p class="text-xs text-gray-500">Simulando retraso de ${SIMULATED_DELAY}ms...</p>
                                </div>
                            ';
                        }
                    } else {
                        overlay.classList.add('hidden');
                    }
                }
            }

            // --- L√ìGICA DE DETALLE Y VISTAS DE ESTACIONAMIENTO ---

            function registerEntry(event) {
                event.preventDefault();
                toggleLoading(true, 'Registrando Ingreso...');

                const spotId = document.getElementById('spotId').value;
                const plate = document.getElementById('plate').value.toUpperCase();
                const carType = document.getElementById('carType').value;
                const messageElement = document.getElementById('register-message');
                messageElement.classList.add('hidden');

                const spotIndex = PARKING_SPOTS.findIndex(s => s.id === spotId);

                if (spotIndex !== -1 && PARKING_SPOTS[spotIndex].status === 'Available') {
                    setTimeout(() => {
                        PARKING_SPOTS[spotIndex] = {
                            id: spotId,
                            status: 'Occupied',
                            plate: plate,
                            entryTime: new Date().toISOString(),
                            carType: carType
                        };
                        messageElement.textContent = `‚úÖ Veh√≠culo ${plate} ingresado con √©xito en ${spotId}.`;
                        messageElement.classList.remove('hidden', 'bg-red-100', 'text-red-700');
                        messageElement.classList.add('bg-green-100', 'text-green-700');
                        
                        // Limpiar formulario y forzar re-render de la p√°gina
                        document.getElementById('plate').value = '';
                        document.getElementById('carType').value = 'Sedan';
                        renderPageAndMenu(false);
                        toggleLoading(false);
                    }, SIMULATED_DELAY);
                } else {
                    setTimeout(() => {
                        messageElement.textContent = `‚ùå Error: La plaza ${spotId} no est√° disponible o es inv√°lida.`;
                        messageElement.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                        messageElement.classList.add('bg-red-100', 'text-red-700');
                        toggleLoading(false);
                    }, SIMULATED_DELAY);
                }
            }

            function registerExit(event) {
                event.preventDefault();
                toggleLoading(true, 'Procesando Salida...');
                
                const plateToExit = document.getElementById('plateToExit').value.toUpperCase();
                const messageElement = document.getElementById('exit-message');
                messageElement.classList.add('hidden');

                const spotIndex = PARKING_SPOTS.findIndex(s => s.plate === plateToExit && s.status === 'Occupied');

                if (spotIndex !== -1) {
                    const spot = PARKING_SPOTS[spotIndex];
                    const entryTime = new Date(spot.entryTime);
                    const exitTime = new Date();
                    const durationMs = exitTime - entryTime;
                    const durationHours = durationMs / (1000 * 60 * 60);
                    
                    // Simulaci√≥n de C√°lculo de Tarifa (S/. 5 por hora)
                    const cost = Math.ceil(durationHours) * 5;
                    const spotId = spot.id;

                    setTimeout(() => {
                        // Liberar la plaza
                        PARKING_SPOTS[spotIndex] = { id: spotId, status: 'Available' };
                        
                        messageElement.innerHTML = `
                            ‚úÖ Salida de ${plateToExit} de la plaza ${spotId} registrada con √©xito.<br>
                            Tiempo: ${durationHours.toFixed(2)} horas | Tarifa (Simulada): **S/. ${cost.toFixed(2)}**
                        `;
                        messageElement.classList.remove('hidden', 'bg-red-100', 'text-red-700');
                        messageElement.classList.add('bg-green-100', 'text-green-700');
                        
                        document.getElementById('plateToExit').value = '';
                        renderPageAndMenu(false);
                        toggleLoading(false);
                    }, SIMULATED_DELAY);
                } else {
                    setTimeout(() => {
                        messageElement.textContent = `‚ùå Error: No se encontr√≥ el veh√≠culo con placa ${plateToExit} ocupando una plaza.`;
                        messageElement.classList.remove('hidden', 'bg-green-100', 'text-green-700');
                        messageElement.classList.add('bg-red-100', 'text-red-700');
                        toggleLoading(false);
                    }, SIMULATED_DELAY);
                }
            }


            // --- L√ìGICA DE AUTENTICACI√ìN ---

            function handleLogin(event) {
                event.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const messageElement = document.getElementById('login-message');

                const userFound = USERS.find(u => u.user === username && u.pass === password);

                if (userFound) {
                    getAppContainer().innerHTML = `
                        <div class="flex items-center justify-center min-h-screen p-4">
                            <div class="p-8 bg-white rounded-xl shadow-2xl flex flex-col items-center space-y-4">
                                ${CAR_LOGO_SVG.replace('logo-loader', 'logo-loader')}
                                <p class="text-lg font-semibold text-park-primary">Iniciando sesi√≥n...</p>
                                <p class="text-xs text-gray-500">Simulando retraso de ${SIMULATED_DELAY}ms...</p>
                            </div>
                        </div>
                    `;

                    setTimeout(() => {
                        currentUser = userFound;
                        currentPage = MENU_CONFIG[currentUser.role][0].id; // Ir a la primera p√°gina del rol
                        renderApp();
                    }, SIMULATED_DELAY);
                } else {
                    messageElement.textContent = 'Error: Credenciales inv√°lidas. Intente de nuevo.';
                    messageElement.classList.remove('hidden');
                }
            }

            function handleLogout() {
                getAppContainer().innerHTML = `
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="p-8 bg-white rounded-xl shadow-2xl flex flex-col items-center space-y-4">
                            ${CAR_LOGO_SVG.replace('logo-loader', 'logo-loader')}
                            <p class="text-lg font-semibold text-red-600">Cerrando sesi√≥n...</p>
                            <p class="text-xs text-gray-500">Simulando retraso de ${SIMULATED_DELAY}ms...</p>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    currentUser = null;
                    selectedSpot = null;
                    renderLogin();
                }, SIMULATED_DELAY);
            }

            // --- RENDERIZADO DE VISTAS Y COMPONENTES ---

            function renderLogin() {
                const exampleUsers = USERS.map(u => `<li class="font-mono">${u.user} / ${u.pass} (**${u.role.toUpperCase()}**)</li>`).join('');

                getAppContainer().innerHTML = `
                    <div class="flex items-center justify-center min-h-screen p-4 bg-gray-900">
                        <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl transition duration-300 transform scale-100 hover:scale-[1.01]">
                            <div class="text-center mb-6">
                                <div class="flex justify-center mb-4">
                                    ${CAR_LOGO_SVG.replace('logo-loader', 'text-park-primary')}
                                </div>
                                <h1 class="text-3xl font-extrabold text-park-primary">üÖøÔ∏è Parking Pro Access</h1>
                                <p class="text-gray-500 mt-1">Gesti√≥n Inteligente de Estacionamientos</p>
                            </div>
                            
                            <form id="login-form" class="space-y-6">
                                <div>
                                    <label for="username" class="block text-sm font-medium text-gray-700">Usuario</label>
                                    <input id="username" name="username" type="text" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-inner focus:ring-park-primary focus:border-park-primary transition duration-150">
                                </div>
                                
                                <div>
                                    <label for="password" class="block text-sm font-medium text-gray-700">Contrase√±a</label>
                                    <input id="password" name="password" type="password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-inner focus:ring-park-primary focus:border-park-primary transition duration-150">
                                </div>
                                
                                <div id="login-message" class="hidden p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg text-sm transition duration-300"></div>

                                <div>
                                    <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-lg text-sm font-medium text-white bg-park-primary hover:bg-park-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-park-primary transition duration-150 transform hover:scale-[1.01]">
                                        <span class="mr-2">üîë</span> Iniciar Sesi√≥n
                                    </button>
                                </div>
                            </form>
                            
                            <div class="mt-6 p-4 bg-gray-50 rounded-lg text-sm text-gray-600">
                                <p class="font-semibold mb-1">Cuentas de Prueba:</p>
                                <ul class="list-disc list-inside space-y-1">
                                    ${exampleUsers}
                                </ul>
                                <p class="mt-2 text-xs text-gray-400">Recomendado: `worker1/parker1`</p>
                            </div>
                        </div>
                    </div>
                `;
                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.addEventListener('submit', handleLogin);
                }
            }
            
            function renderApp() {
                const allowedMenuItems = MENU_CONFIG[currentUser.role] || [];
                
                const navHtml = allowedMenuItems.map(item => {
                    const isActive = currentPage === item.id;
                    const activeClasses = isActive ? 'bg-park-secondary text-white shadow-md font-bold' : 'text-indigo-200 hover:bg-indigo-700 hover:text-white';

                    return `<a href="#" data-page="${item.id}" class="nav-link flex items-center px-4 py-2 rounded-lg transition duration-150 ${activeClasses}"><span class="mr-3">${item.icon}</span>${item.label}</a>`;
                }).join('');

                getAppContainer().innerHTML = `
                    <div class="flex flex-col h-screen">
                        
                        <header class="bg-white shadow-lg p-4 flex justify-between items-center z-10 border-b-4 border-park-primary">
                            <div class="flex items-center space-x-2">
                                <div class="h-6 w-6 text-park-primary">${CAR_LOGO_SVG.replace('logo-loader', '').replace(/80/g, '24').replace(/viewBox="0 0 100 100"/, 'viewBox="0 0 24 24"')}</div>
                                <h1 class="text-xl font-extrabold text-park-primary">PARKING PRO</h1>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-sm text-gray-600 hidden sm:block">¬°Hola, ${currentUser.name}! (${currentUser.role.toUpperCase()})</span>
                                <button id="logout-button" class="flex items-center bg-red-600 hover:bg-red-700 text-white text-sm py-1 px-3 rounded-full shadow-md transition duration-150">
                                    <span class="mr-1">üö™</span> Salir
                                </button>
                            </div>
                        </header>

                        <div class="flex flex-1 overflow-hidden">
                            
                            <nav id="sidebar" class="bg-indigo-800 w-64 p-4 space-y-2 hidden md:block">
                                <div class="pb-4 mb-4 border-b border-indigo-700">
                                    <p class="text-white font-bold text-lg">${currentUser.name}</p>
                                    <p class="text-indigo-300 text-sm">${currentUser.role.toUpperCase()}</p>
                                </div>
                                ${navHtml}
                            </nav>

                            <main class="flex-1 p-6 overflow-y-auto bg-gray-100">
                                <div id="page-content" class="h-full">
                                    ${generatePageContent(currentPage)}
                                </div>
                            </main>
                            
                        </div>
                        
                        <div id="loading-overlay" class="fixed inset-0 flex items-center justify-center bg-gray-50 bg-opacity-90 z-50 hidden transition-opacity duration-300">
                            <div id="loading-message" class="p-8 bg-white rounded-xl shadow-2xl flex flex-col items-center space-y-4">
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('logout-button').addEventListener('click', handleLogout);

                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const newPage = this.getAttribute('data-page');
                        
                        const allowedPages = allowedMenuItems.map(item => item.id);
                        if (allowedPages.includes(newPage) && newPage !== currentPage) {
                            toggleLoading(true, 'Cambiando de m√≥dulo...');
                            setTimeout(() => {
                                currentPage = newPage;
                                selectedSpot = null;
                                renderPageAndMenu();
                                toggleLoading(false);
                            }, SIMULATED_DELAY);
                        }
                    });
                });
                
                // Adjuntar listeners espec√≠ficos de cada p√°gina (ej. formularios de entrada/salida)
                attachPageListeners();
            }
            
            function renderPageAndMenu(updateMenu = true) {
                const pageContent = document.getElementById('page-content');
                if(pageContent) {
                    pageContent.innerHTML = generatePageContent(currentPage);
                }
                
                if (updateMenu) {
                    // Actualizar estado activo en el men√∫ lateral
                    document.querySelectorAll('.nav-link').forEach(link => {
                        const pageId = link.getAttribute('data-page');
                        const isActive = pageId === currentPage;
                        link.classList.toggle('bg-park-secondary', isActive);
                        link.classList.toggle('text-white', isActive);
                        link.classList.toggle('shadow-md', isActive);
                        link.classList.toggle('font-bold', isActive);
                        link.classList.toggle('text-indigo-200', !isActive);
                        link.classList.toggle('hover:bg-indigo-700', !isActive);
                        link.classList.toggle('hover:text-white', !isActive);
                    });
                }

                attachPageListeners();
            }
            
            function attachPageListeners() {
                if (currentPage === 'register_entry') {
                    const entryForm = document.getElementById('entry-form');
                    if (entryForm) entryForm.addEventListener('submit', registerEntry);
                } else if (currentPage === 'register_exit') {
                    const exitForm = document.getElementById('exit-form');
                    if (exitForm) exitForm.addEventListener('submit', registerExit);
                }
            }

            function generatePageContent(pageId) {
                
                if (!currentUser) return '';

                switch (pageId) {
                    case 'dashboard':
                        return renderDashboardPage();
                    case 'parking_map':
                        return renderParkingMapPage();
                    case 'register_entry':
                        return renderRegisterEntryPage();
                    case 'register_exit':
                        return renderRegisterExitPage();
                    case 'admin_reports':
                        return renderAdminReportsPage();
                    default:
                        const title = 'P√°gina No Encontrada';
                        const content = '<p class="text-red-600">El m√≥dulo solicitado no existe o no tiene permisos.</p>';
                        return `<div class="bg-white p-6 rounded-xl shadow-lg h-full"><h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">${title}</h2>${content}</div>`;
                }
            }

            // --- VISTAS ESPEC√çFICAS DE PARKING ---

            function renderDashboardPage() {
                const totalSpots = PARKING_SPOTS.length;
                const occupiedSpots = PARKING_SPOTS.filter(s => s.status === 'Occupied').length;
                const availableSpots = totalSpots - occupiedSpots;

                const availableColor = 'bg-green-100 text-green-800';
                const occupiedColor = 'bg-red-100 text-red-800';
                const totalColor = 'bg-park-primary text-white';

                const totalRevenueEstimate = occupiedSpots * 5 * 8; // Simulaci√≥n: 8 horas promedio a 5 S/. la hora.

                return `
                    <div class="space-y-6">
                        <h2 class="text-3xl font-extrabold text-gray-900 border-b pb-3 mb-4">üè† Dashboard General</h2>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="p-6 rounded-xl shadow-lg ${totalColor}">
                                <p class="text-sm font-medium opacity-80 mb-2">Plazas Totales</p>
                                <p class="text-4xl font-extrabold">${totalSpots}</p>
                                <p class="mt-2 text-sm opacity-80">Capacidad M√°xima del Parking</p>
                            </div>

                            <div class="p-6 rounded-xl shadow-lg ${availableColor} border-2 border-green-400">
                                <p class="text-sm font-medium mb-2">Disponibles</p>
                                <p class="text-4xl font-extrabold">${availableSpots}</p>
                                <p class="mt-2 text-sm">Listas para ser ocupadas</p>
                            </div>

                            <div class="p-6 rounded-xl shadow-lg ${occupiedColor} border-2 border-red-400">
                                <p class="text-sm font-medium mb-2">Ocupadas</p>
                                <p class="text-4xl font-extrabold">${occupiedSpots}</p>
                                <p class="mt-2 text-sm">Veh√≠culos en el interior</p>
                            </div>
                        </div>

                        <div class="p-6 rounded-xl shadow-lg bg-white">
                            <h3 class="text-xl font-bold text-park-primary mb-3">Resumen R√°pido</h3>
                            <p class="text-gray-700">Bienvenido **${currentUser.name}** (${currentUser.role.toUpperCase()}).</p>
                            <p class="mt-2 p-3 rounded-lg bg-gray-50 border border-gray-200 text-sm text-gray-700">
                                **Proyecci√≥n de Ingresos Diarios (Simulada):** S/. ${totalRevenueEstimate.toFixed(2)} (Basado en la ocupaci√≥n actual y un promedio de permanencia).
                            </p>
                        </div>
                    </div>
                `;
            }

            function renderParkingMapPage() {
                const spotGroups = PARKING_SPOTS.reduce((acc, spot) => {
                    const groupKey = spot.id.substring(0, 1);
                    if (!acc[groupKey]) acc[groupKey] = [];
                    acc[groupKey].push(spot);
                    return acc;
                }, {});

                let mapHtml = '';
                for (const groupKey in spotGroups) {
                    mapHtml += `
                        <h3 class="text-2xl font-bold text-gray-800 mt-6 mb-4 border-b-2 border-gray-200 pb-1">Secci√≥n ${groupKey}</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                            ${spotGroups[groupKey].map(renderParkingSpotCard).join('')}
                        </div>
                    `;
                }

                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg h-full">
                        <h2 class="text-3xl font-extrabold text-gray-900 border-b pb-3 mb-4">üó∫Ô∏è Mapa de Plazas de Estacionamiento</h2>
                        <p class="text-gray-600 mb-6">Vista en tiempo real del estado de cada plaza.</p>
                        
                        ${mapHtml}

                        <p class="mt-8 text-sm text-gray-500 italic text-center">
                            Estado: <span class="text-green-600">Libre</span> | <span class="text-red-600">Ocupado</span>
                        </p>
                    </div>
                `;
            }

            function renderParkingSpotCard(spot) {
                const isOccupied = spot.status === 'Occupied';
                const baseClasses = 'parking-spot p-4 rounded-xl text-center shadow-md border-b-4 transition duration-200';
                
                let statusClasses = '';
                let content = '';

                if (isOccupied) {
                    statusClasses = 'bg-red-50 border-red-500 hover:bg-red-100';
                    const entry = new Date(spot.entryTime).toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
                    content = `
                        <p class="text-xl font-extrabold text-red-700">${spot.id}</p>
                        <p class="text-xs font-semibold text-gray-600 mt-1">${spot.plate}</p>
                        <p class="text-xs text-gray-500 mt-1">Ingreso: ${entry}</p>
                    `;
                } else {
                    statusClasses = 'bg-green-50 border-green-500 hover:bg-green-100 cursor-pointer';
                    content = `
                        <p class="text-xl font-extrabold text-green-700">${spot.id}</p>
                        <p class="text-sm font-semibold text-green-600 mt-2">LIBRE</p>
                        <p class="text-xs text-gray-400 mt-1">Click para Ingreso</p>
                    `;
                }
                
                // Uso de un controlador de URL hash para activar la funci√≥n de entrada con el spot preseleccionado.
                return `<div class="${baseClasses} ${statusClasses}" onclick="window.location.hash='#register_entry?spot=${spot.id}'">${content}</div>`;
            }

            function renderRegisterEntryPage() {
                const availableSpots = PARKING_SPOTS.filter(s => s.status === 'Available');
                // Se ordena alfab√©ticamente
                availableSpots.sort((a, b) => a.id.localeCompare(b.id)); 
                
                // Determinar el spot preseleccionado si viene de la URL (ej. #register_entry?spot=A02)
                const urlParams = new URLSearchParams(window.location.hash.substring(1));
                const preselectedSpotId = urlParams.get('spot');
                const defaultSpot = preselectedSpotId && availableSpots.find(s => s.id === preselectedSpotId) ? preselectedSpotId : (availableSpots.length > 0 ? availableSpots[0].id : '');

                // Generar las opciones, marcando la preseleccionada
                const correctedSpotOptions = availableSpots.map(s => {
                    const selectedAttr = s.id === defaultSpot ? 'selected' : '';
                    return `<option value="${s.id}" ${selectedAttr}>${s.id}</option>`;
                }).join('');

                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto">
                        <h2 class="text-3xl font-extrabold text-park-primary border-b pb-3 mb-6">‚¨ÜÔ∏è Registrar Ingreso de Veh√≠culo</h2>
                        <p id="register-message" class="hidden p-3 rounded-lg text-sm mb-4 transition duration-300" role="alert"></p>

                        <form id="entry-form" class="space-y-4">
                            <div>
                                <label for="spotId" class="block text-sm font-medium text-gray-700">Plaza de Estacionamiento Disponible</label>
                                <select id="spotId" name="spotId" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-park-primary focus:border-park-primary transition duration-150">
                                    ${correctedSpotOptions}
                                </select>
                                ${availableSpots.length === 0 ? '<p class="text-red-500 mt-1">‚ö†Ô∏è No hay plazas disponibles.</p>' : ''}
                            </div>
                            
                            <div>
                                <label for="plate" class="block text-sm font-medium text-gray-700">Placa del Veh√≠culo</label>
                                <input id="plate" name="plate" type="text" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm uppercase focus:ring-park-primary focus:border-park-primary transition duration-150" maxlength="7" placeholder="ABC-123">
                            </div>
                            
                            <div>
                                <label for="carType" class="block text-sm font-medium text-gray-700">Tipo de Veh√≠culo</label>
                                <select id="carType" name="carType" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-park-primary focus:border-park-primary transition duration-150">
                                    <option value="Sedan">Sed√°n/Hatchback</option>
                                    <option value="SUV">SUV/Crossover</option>
                                    <option value="Truck">Camioneta/Pick-up</option>
                                    <option value="Moto">Motocicleta</option>
                                    <option value="Other">Otro</option>
                                </select>
                            </div>
                            
                            <button type="submit" ${availableSpots.length === 0 ? 'disabled' : ''} class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-park-primary hover:bg-park-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-park-primary transition duration-150 transform hover:scale-[1.01] disabled:opacity-50 disabled:hover:scale-100">
                                Registrar Ingreso Ahora
                            </button>
                        </form>
                    </div>
                `;
            }

            function renderRegisterExitPage() {
                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg max-w-lg mx-auto">
                        <h2 class="text-3xl font-extrabold text-red-600 border-b pb-3 mb-6">‚¨áÔ∏è Registrar Salida de Veh√≠culo</h2>
                        <p class="text-gray-600 mb-4">Ingrese la placa del veh√≠culo que est√° saliendo para calcular la tarifa y liberar la plaza.</p>
                        <p id="exit-message" class="hidden p-3 rounded-lg text-sm mb-4 transition duration-300" role="alert"></p>

                        <form id="exit-form" class="space-y-4">
                            <div>
                                <label for="plateToExit" class="block text-sm font-medium text-gray-700">Placa del Veh√≠culo a Salir</label>
                                <input id="plateToExit" name="plateToExit" type="text" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm uppercase focus:ring-red-500 focus:border-red-500 transition duration-150" maxlength="7" placeholder="LMA-123">
                            </div>
                            
                            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-600 transition duration-150 transform hover:scale-[1.01]">
                                Procesar Salida y Cobro
                            </button>
                        </form>
                    </div>
                `;
            }

            function renderAdminReportsPage() {
                // Generar una tabla simple con todos los veh√≠culos ocupados para un reporte b√°sico
                const occupiedVehicles = PARKING_SPOTS.filter(s => s.status === 'Occupied');

                let tableRows = occupiedVehicles.map(spot => {
                    const entryTime = new Date(spot.entryTime);
                    const now = new Date();
                    const durationMs = now - entryTime;
                    const durationHours = (durationMs / (1000 * 60 * 60)).toFixed(2);
                    
                    return `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="px-6 py-3 font-semibold text-park-primary">${spot.id}</td>
                            <td class="px-6 py-3 font-mono">${spot.plate}</td>
                            <td class="px-6 py-3">${spot.carType}</td>
                            <td class="px-6 py-3">${entryTime.toLocaleString('es-PE')}</td>
                            <td class="px-6 py-3 text-red-600">${durationHours} hrs</td>
                            <td class="px-6 py-3 text-green-600">S/. ${(Math.ceil(durationHours) * 5).toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
                
                if (occupiedVehicles.length === 0) {
                    tableRows = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500 italic">No hay veh√≠culos ocupando plazas actualmente.</td></tr>';
                }

                return `
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-extrabold text-gray-900 border-b pb-3 mb-6">üìä Reportes y Cierres</h2>
                        <p class="text-gray-600 mb-4">Reporte detallado de la ocupaci√≥n actual y c√°lculo de ingresos proyectados.</p>

                        <div class="overflow-x-auto shadow-md rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Plaza</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placa</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hora Ingreso</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Duraci√≥n (hrs)</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarifa Proyectada</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${tableRows}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }
            
            // --- INICIO DE LA APLICACI√ìN ---

            // Inicialmente, renderiza la vista de Login
            renderLogin();
            
            // Para depuraci√≥n, si la carga inicial fue exitosa, podemos simular un inicio r√°pido si lo deseas.
            console.log("Sistema cargado. Listo para iniciar sesi√≥n.");

        })();
    </script>
</body>
</html>
