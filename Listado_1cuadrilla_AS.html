<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Asistencia - Primera Cuadrilla</title>
    
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ========================================================== */
        /* Estilos CSS Base y Colores */
        /* ========================================================== */

        :root {
            --color-principal: #F5F5DC; /* Cream (Crema) */
            --color-secundario: #FAF0E6; /* Linen (Blanco roto) */
            --color-acento: #A0522D; /* Sienna (Marr√≥n medio) (Marr√≥n fuerte) */
            --color-texto-oscuro: #3E2723; /* Marr√≥n oscuro para texto */
            --color-borde: #D2B48C; /* Tan (Marr√≥n claro) */
            --color-exito: #38761D; /* Verde oscuro */
            --color-peligro: #CC0000; /* Rojo oscuro */
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-secundario);
            color: var(--color-texto-oscuro);
        }

        .contenedor {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
            background-color: var(--color-principal);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 30px;
        }
        
        /* ---------------------------------------------------------- */
        /* Estilos del Encabezado (sin cambios) */
        /* ---------------------------------------------------------- */
        header {
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            padding-bottom: 20px;
            border-bottom: 3px solid var(--color-acento);
            margin-bottom: 30px;
        }

        .header-titulo {
            flex-grow: 1; 
            text-align: center;
        }

        .header-titulo h1 {
            color: var(--color-acento);
            font-size: 2.2em; 
            margin: 0;
        }
        
        .header-titulo p {
            margin: 5px 0 0 0;
        }

        .logo-espacio {
            width: 100px; 
            height: 100px;
            border: 2px dashed var(--color-borde);
            border-radius: 50%; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8em;
            color: var(--color-acento);
            flex-shrink: 0; 
            padding: 5px;
            box-sizing: border-box;
            background-color: white; 
        }
        
        /* ---------------------------------------------------------- */
        /* Estilos del Dashboard (sin cambios relevantes) */
        /* ---------------------------------------------------------- */
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--color-secundario);
            border: 1px solid var(--color-borde);
        }

        .tarjeta-resumen {
            flex: 1 1 calc(33.33% - 20px); 
            min-width: 250px; 
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 5px solid var(--color-acento);
        }

        .tarjeta-resumen h3 {
            margin-top: 0;
            color: var(--color-acento);
            font-size: 1.1em;
            text-transform: uppercase;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 150px; 
            height: 150px;
            margin: 10px auto 0 auto; 
        }
        
        .tarjeta-resumen .valor {
            font-size: 2.5em;
            font-weight: bold;
            color: var(--color-texto-oscuro);
            margin-top: 15px; 
        }
        .tarjeta-resumen .descripcion {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        /* ---------------------------------------------------------- */
        /* Estilos de la Tabla (a√±adida columna Detalle) */
        /* ---------------------------------------------------------- */

        .tabla-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border: 1px solid var(--color-borde);
            border-radius: 8px;
            overflow: hidden; 
        }

        th, td {
            padding: 14px 18px;
            text-align: center;
            border-bottom: 1px solid var(--color-borde);
            border-right: 1px solid var(--color-borde);
        }

        th:last-child, td:last-child {
            border-right: none;
        }

        thead th {
            background-color: var(--color-acento);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        tbody tr:hover {
            background-color: #E8E4D9; 
            transition: background-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        }

        tbody tr:nth-child(even) {
            background-color: #FCF8F3; 
        }

        .asistio { color: var(--color-exito); font-weight: bold; } 
        .falto { color: var(--color-peligro); font-weight: bold; } 
        
        /* Estilo para el bot√≥n de Detalle */
        .btn-detalle {
            background-color: var(--color-acento);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
        }
        .btn-detalle:hover {
            background-color: #8B4513; 
        }


        /* ========================================================== */
        /* Estilos para el MODAL (POP-UP) */
        /* ========================================================== */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Oculto por defecto */
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0; /* Para el efecto fade-in */
            transition: opacity 0.3s ease;
        }

        .modal-backdrop.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: white;
            color: var(--color-texto-oscuro);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 700px;
            transform: scale(0.9); /* Para el efecto de zoom-in */
            transition: transform 0.3s ease;
            position: relative;
        }
        
        .modal-backdrop.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            border-bottom: 1px solid var(--color-borde);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--color-acento);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--color-acento);
            padding: 5px;
            transition: color 0.2s;
        }
        .close-btn:hover {
            color: var(--color-peligro);
        }

        /* Estilos internos del modal */
        .modal-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
            border: 1px solid var(--color-borde);
            padding: 15px;
            border-radius: 8px;
            background-color: var(--color-secundario);
        }
        
        .modal-detalle-tabla {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .modal-detalle-tabla th, .modal-detalle-tabla td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        .modal-detalle-tabla th {
            background-color: var(--color-acento);
            color: white;
            text-transform: uppercase;
            font-size: 0.85em;
        }

        .modal-bar-chart-container {
            width: 100%;
            height: 100px; /* Altura fija para la barra de asistencia */
        }
        
        /* Media Queries (sin cambios relevantes) */
        @media (max-width: 768px) {
             /* ... */
            .modal-content {
                width: 95%;
                padding: 20px;
            }
            .modal-stats {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>

    <div class="contenedor fade-in">
        <header>
            <div class="logo-espacio" id="logoCuadrilla">
                <img src="https://edwinhsvcl14-maker.github.io/asistencias/logo_1cuadrilla.png" alt="Logo de la Cuadrilla" style="width: 80%; height: 80%; object-fit: cover; border-radius: 50%;">
            </div>
            <div class="header-titulo">
                <h1>Control de Asistencia Primera Cuadrilla</h1>
                <p>Listado detallado de participaci√≥n en actividades.</p>
            </div>
            <div class="logo-espacio" style="visibility: hidden;">
                </div> 
        </header>

        <h2>üìä Resumen de Participaci√≥n</h2>
        <section class="dashboard">
            <div class="tarjeta-resumen">
                <h3>Total de Hermanos</h3>
                <div class="valor" id="totalHermanos">0</div>
                <p class="descripcion">Miembros activos en la lista.</p>
            </div>

            <div class="tarjeta-resumen">
                <h3>Promedio General</h3>
                <div class="chart-container">
                    <canvas id="chartPromedioGeneral"></canvas>
                </div>
            </div>

            <div class="tarjeta-resumen">
                <h3>Participaci√≥n Misas</h3>
                <div class="chart-container">
                    <canvas id="chartPromedioMisas"></canvas>
                </div>
            </div>
        </section>
        
        <h2>üìã Detalle de Asistencias</h2>
        <div class="tabla-responsive">
            <table id="tablaAsistencias">
                <thead>
                    <tr>
                        <th style="text-align: left;">Nombre y Apellido</th>
                        <th>Misas de Retiro</th>
                        <th>Asambleas</th>
                        <th>Jornadas</th>
                        <th>Total Asistencias</th>
                        <th>Acciones</th> </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div class="pie-pagina">
            <button id="btnDescargarPDF">Descargar Reporte Detallado (Simulaci√≥n)</button>
        </div>
    </div>
    
    <div id="detalleModal" class="modal-backdrop">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalNombreHermano">Detalle de Asistencia</h2>
                <button class="close-btn" onclick="cerrarModal()">&times;</button>
            </div>

            <div class="modal-body">
                
                <div class="modal-stats">
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: bold; font-size: 1.1em;">Asistencia Individual</p>
                        <p style="margin: 5px 0 0 0;">(Eventos asistidos / Eventos totales)</p>
                    </div>
                    <div class="modal-bar-chart-container" style="flex: 2;">
                        <canvas id="chartAsistenciaIndividual"></canvas>
                    </div>
                </div>

                <table class="modal-detalle-tabla">
                    <thead>
                        <tr>
                            <th>Evento</th>
                            <th>Sub-Evento</th>
                            <th>Asistencia</th>
                        </tr>
                    </thead>
                    <tbody id="modalDetalleBody">
                        </tbody>
                </table>
            </div>

        </div>
    </div>
    <script>
        // Datos simulados con sub-eventos detallados
        const datosAsistencias = [
            { 
                id: 1, 
                nombre: "ALVA ALVAREZ ALFONSO DE JESUS", 
                eventos: {
                    retiro: [{ nombre: "Misa Agosto", asistio: true }, { nombre: "Misa Septiembre", asistio: true }],
                    asamblea: [{ nombre: "Asamblea Mayo", asistio: true }, { nombre: "Asamblea Octubre", asistio: true }],
                    jornadas: [{ nombre: "Jornada 1", asistio: false }]
                }
            },
            { 
                id: 2, 
                nombre: "AQUIJE VALDEZ WILLY HUDSON", 
                eventos: {
                    retiro: [{ nombre: "Misa Agosto", asistio: true }, { nombre: "Misa Septiembre", asistio: true }],
                    asamblea: [{ nombre: "Asamblea Mayo", asistio: true }, { nombre: "Asamblea Octubre", asistio: false }],
                    jornadas: [{ nombre: "Jornada 1", asistio: false }]
                }
            },
            // ************ SIMULAMOS EL RESTO DE LOS 74 HERMANOS ************
            // Para mantener el ejemplo funcional, el resto de los hermanos tendr√°n los mismos eventos y asistencias que el Hno. 2
            // En un caso real, aqu√≠ ir√≠an 72 objetos m√°s con IDs √∫nicos.
            // Para la simulaci√≥n, generamos 72 m√°s basados en el hermano 2.
            ...Array.from({ length: 72 }, (_, i) => ({ 
                id: i + 3, 
                nombre: `HERMANO SIMULADO ${i + 3}`, 
                eventos: {
                    retiro: [{ nombre: "Misa Agosto", asistio: true }, { nombre: "Misa Septiembre", asistio: true }],
                    asamblea: [{ nombre: "Asamblea Mayo", asistio: true }, { nombre: "Asamblea Octubre", asistio: false }],
                    jornadas: [{ nombre: "Jornada 1", asistio: false }]
                }
            }))
        ];

        const tablaBody = document.querySelector('#tablaAsistencias tbody');
        const btnDescargar = document.getElementById('btnDescargarPDF');
        const detalleModal = document.getElementById('detalleModal');
        const modalDetalleBody = document.getElementById('modalDetalleBody');

        let chartPromedioGeneral;
        let chartPromedioMisas;
        let chartAsistenciaIndividual;

        // Colores y variables del CSS
        const colorTextoOscuro = getComputedStyle(document.documentElement).getPropertyValue('--color-texto-oscuro').trim();
        const colorAcento = getComputedStyle(document.documentElement).getPropertyValue('--color-acento').trim();
        const colorExito = getComputedStyle(document.documentElement).getPropertyValue('--color-exito').trim();
        const colorFondoGrafico = '#E0E0E0'; 

        // ** Plugin para mostrar texto en el centro del gr√°fico (Chart.js)**
        const centerTextPlugin = {
            id: 'centerText',
            beforeDraw: function(chart) {
                if (chart.config.options.plugins.centerText) {
                    const {width, height, ctx} = chart;
                    ctx.restore();
                    
                    const percentage = chart.data.datasets[0].data[0].toFixed(1);
                    
                    const fontSize = (height / 120).toFixed(2);
                    ctx.font = `bold ${fontSize}em 'Georgia', serif`;
                    ctx.textBaseline = "middle";

                    const text = `${percentage}%`;
                    const textX = Math.round((width - ctx.measureText(text).width) / 2);
                    const textY = height / 2;

                    ctx.fillStyle = colorTextoOscuro; 
                    ctx.fillText(text, textX, textY);
                    ctx.save();
                }
            }
        };
        Chart.register(centerTextPlugin);

        // --- Funciones del Dashboard Global ---

        function calcularEstadisticas() {
            const totalHermanos = datosAsistencias.length;
            let totalMisasAsistidas = 0;
            let sumaTotalAsistenciasEventosIndividuales = 0; 
            
            // Calculamos el n√∫mero de sub-eventos totales que definen la base 100%
            // Usamos el primer hermano como plantilla, asumiendo que todos tienen los mismos sub-eventos
            const eventosPlantilla = datosAsistencias[0].eventos;
            const numeroTotalSubEventos = eventosPlantilla.retiro.length + eventosPlantilla.asamblea.length + eventosPlantilla.jornadas.length;

            datosAsistencias.forEach(persona => {
                let asistenciasPersona = 0;
                
                Object.values(persona.eventos).forEach(subEventos => {
                    subEventos.forEach(evento => {
                        if (evento.asistio) {
                            asistenciasPersona++;
                        }
                    });
                });
                
                sumaTotalAsistenciasEventosIndividuales += asistenciasPersona;
                
                // Calculamos asistencias a 'Misas de Retiro' (Asisti√≥ al menos a 1/2)
                const asistioMisa = persona.eventos.retiro.some(e => e.asistio);
                if (asistioMisa) totalMisasAsistidas++;
            });

            // Calculo del promedio general basado en sub-eventos
            const totalAsistenciasPosiblesEnTodosLosEventos = totalHermanos * numeroTotalSubEventos;
            const promedioGeneralPorcentaje = (sumaTotalAsistenciasEventosIndividuales / totalAsistenciasPosiblesEnTodosLosEventos) * 100;

            // Promedio de participaci√≥n en Misas (Porcentaje de hermanos que asistieron a alguna Misa)
            const promedioMisasPorcentaje = (totalMisasAsistidas / totalHermanos) * 100;

            return {
                totalHermanos,
                promedioGeneral: parseFloat(promedioGeneralPorcentaje.toFixed(1)),
                promedioMisas: parseFloat(promedioMisasPorcentaje.toFixed(1)),
                numeroTotalSubEventos // Para el c√°lculo interno
            };
        }

        function renderizarDashboard() {
            const stats = calcularEstadisticas();
            
            document.getElementById('totalHermanos').textContent = stats.totalHermanos;

            // 1. Gr√°fico de Promedio General
            const ctxGeneral = document.getElementById('chartPromedioGeneral').getContext('2d');
            if (chartPromedioGeneral) chartPromedioGeneral.destroy();
            chartPromedioGeneral = new Chart(ctxGeneral, {
                type: 'doughnut',
                data: { datasets: [{
                    data: [stats.promedioGeneral, 100 - stats.promedioGeneral],
                    backgroundColor: [colorExito, colorFondoGrafico],
                    hoverOffset: 4
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '75%', 
                    plugins: { legend: { display: false }, tooltip: { enabled: true }, centerText: true },
                    animation: { animateRotate: true, animateScale: true }
                }
            });

            // 2. Gr√°fico de Participaci√≥n en Misas
            const ctxMisas = document.getElementById('chartPromedioMisas').getContext('2d');
            if (chartPromedioMisas) chartPromedioMisas.destroy();
            chartPromedioMisas = new Chart(ctxMisas, {
                type: 'doughnut',
                data: { datasets: [{
                    data: [stats.promedioMisas, 100 - stats.promedioMisas],
                    backgroundColor: [colorAcento, colorFondoGrafico],
                    hoverOffset: 4
                }]},
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '75%',
                    plugins: { legend: { display: false }, tooltip: { enabled: true }, centerText: true },
                    animation: { animateRotate: true, animateScale: true }
                }
            });
        }

        // --- Funciones de la Tabla y el Modal ---

        function obtenerResumenAsistencias(hermano) {
            let resumen = { retiro: 0, asamblea: 0, jornadas: 0, total: 0 };
            
            Object.keys(hermano.eventos).forEach(tipo => {
                hermano.eventos[tipo].forEach(evento => {
                    if (evento.asistio) {
                        resumen[tipo]++;
                        resumen.total++;
                    }
                });
            });
            return resumen;
        }

        function renderizarTabla() {
            tablaBody.innerHTML = ''; 

            datosAsistencias.forEach(persona => {
                const resumen = obtenerResumenAsistencias(persona);
                const fila = document.createElement('tr');

                const celdaNombre = document.createElement('td');
                celdaNombre.textContent = persona.nombre;
                celdaNombre.style.textAlign = 'left'; 
                fila.appendChild(celdaNombre);

                // Celda Resumen Misas
                let celdaMisa = document.createElement('td');
                celdaMisa.textContent = persona.eventos.retiro.some(e => e.asistio) ? '‚úÖ' : '‚ùå';
                celdaMisa.classList.add(persona.eventos.retiro.some(e => e.asistio) ? 'asistio' : 'falto');
                fila.appendChild(celdaMisa);
                
                // Celda Resumen Asambleas
                let celdaAsamblea = document.createElement('td');
                celdaAsamblea.textContent = persona.eventos.asamblea.some(e => e.asistio) ? '‚úÖ' : '‚ùå';
                celdaAsamblea.classList.add(persona.eventos.asamblea.some(e => e.asistio) ? 'asistio' : 'falto');
                fila.appendChild(celdaAsamblea);

                // Celda Resumen Jornadas
                let celdaJornada = document.createElement('td');
                celdaJornada.textContent = persona.eventos.jornadas.some(e => e.asistio) ? '‚úÖ' : '‚ùå';
                celdaJornada.classList.add(persona.eventos.jornadas.some(e => e.asistio) ? 'asistio' : 'falto');
                fila.appendChild(celdaJornada);


                const celdaTotal = document.createElement('td');
                celdaTotal.textContent = resumen.total;
                celdaTotal.style.fontWeight = 'bold';
                fila.appendChild(celdaTotal);
                
                // Nueva Celda: Ver Detalle
                const celdaAccion = document.createElement('td');
                const btnDetalle = document.createElement('button');
                btnDetalle.textContent = 'Ver Detalle';
                btnDetalle.classList.add('btn-detalle');
                btnDetalle.onclick = () => abrirModal(persona.id);
                celdaAccion.appendChild(btnDetalle);
                fila.appendChild(celdaAccion);

                tablaBody.appendChild(fila);
            });
        }

        function abrirModal(idHermano) {
            const hermano = datosAsistencias.find(p => p.id === idHermano);
            if (!hermano) return;

            document.getElementById('modalNombreHermano').textContent = `Detalle de Asistencia: ${hermano.nombre}`;
            modalDetalleBody.innerHTML = '';
            
            let asistidos = 0;
            let totales = 0;
            
            // Cargar tabla interna
            Object.keys(hermano.eventos).forEach(tipo => {
                hermano.eventos[tipo].forEach(evento => {
                    const fila = document.createElement('tr');
                    
                    const celdaTipo = document.createElement('td');
                    celdaTipo.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);
                    
                    const celdaNombre = document.createElement('td');
                    celdaNombre.textContent = evento.nombre;

                    const celdaAsistencia = document.createElement('td');
                    celdaAsistencia.textContent = evento.asistio ? '‚úÖ Asisti√≥' : '‚ùå Falt√≥';
                    celdaAsistencia.classList.add(evento.asistio ? 'asistio' : 'falto');
                    
                    if(evento.asistio) asistidos++;
                    totales++;

                    fila.appendChild(celdaTipo);
                    fila.appendChild(celdaNombre);
                    fila.appendChild(celdaAsistencia);
                    modalDetalleBody.appendChild(fila);
                });
            });
            
            // Renderizar gr√°fico interno (Barra de Progreso Horizontal)
            renderizarChartIndividual(asistidos, totales);

            // Mostrar Modal con animaci√≥n
            detalleModal.style.display = 'flex';
            // Peque√±o delay para forzar la transici√≥n CSS (fade-in)
            setTimeout(() => detalleModal.classList.add('show'), 10); 
        }

        function cerrarModal() {
            detalleModal.classList.remove('show');
            // Ocultar completamente despu√©s de la transici√≥n
            setTimeout(() => detalleModal.style.display = 'none', 300); 
        }
        
        // Funci√≥n para el gr√°fico de barra horizontal (interno del modal)
        function renderizarChartIndividual(asistidos, totales) {
            const porcentaje = (asistidos / totales) * 100;
            const ctxIndividual = document.getElementById('chartAsistenciaIndividual').getContext('2d');
            
            if (chartAsistenciaIndividual) chartAsistenciaIndividual.destroy();

            chartAsistenciaIndividual = new Chart(ctxIndividual, {
                type: 'bar',
                data: {
                    labels: ['Asistencia'],
                    datasets: [{
                        label: 'Porcentaje de Asistencia',
                        data: [porcentaje.toFixed(1)],
                        backgroundColor: colorExito,
                        borderColor: colorExito,
                        borderWidth: 1,
                        barPercentage: 1.0,
                        categoryPercentage: 1.0
                    },
                    {
                        label: 'Faltas',
                        data: [(100 - porcentaje).toFixed(1)],
                        backgroundColor: colorFondoGrafico,
                        borderColor: colorFondoGrafico,
                        borderWidth: 1,
                        barPercentage: 1.0,
                        categoryPercentage: 1.0
                    }]
                },
                options: {
                    indexAxis: 'y', // Hace la barra horizontal
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            max: 100,
                            min: 0,
                            display: false // Oculta los ejes X
                        },
                        y: {
                            stacked: true,
                            display: false // Oculta los ejes Y
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: true },
                        // Plugin para mostrar texto de porcentaje en la barra
                        centerText: { // Reutilizamos el plugin, pero para la barra horizontal
                             percentage: `${porcentaje.toFixed(1)}% (${asistidos}/${totales})`
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuad'
                    }
                },
                plugins: [{
                    // Sobreescribe centerText para usarlo en la barra horizontal
                    id: 'centerTextBar',
                    beforeDraw: function(chart) {
                        if (chart.canvas.id === 'chartAsistenciaIndividual') {
                            const {width, height, ctx} = chart;
                            ctx.restore();
                            
                            const text = `${porcentaje.toFixed(1)}% (${asistidos}/${totales})`;
                            
                            ctx.font = `bold 1em 'Georgia', serif`;
                            ctx.textBaseline = "middle";

                            const textX = 10; // Posici√≥n fija a la izquierda
                            const textY = height / 2;

                            ctx.fillStyle = colorTextoOscuro; 
                            ctx.fillText(text, textX, textY);
                            ctx.save();
                        }
                    }
                }]
            });
        }


        // Funcionalidad de la descarga (sin cambios)
        function descargarPDF() {
            alert("Simulando la generaci√≥n y descarga del reporte detallado. En un sistema real, el archivo se descargar√≠a ahora.");
            
            const contenido = "--- Reporte Detallado de Asistencias - Primera Cuadrilla ---\n\n" + 
                              "Nombre | Total Sub-Eventos Asistidos\n" +
                              "---------------------------------------------------\n" +
                              datosAsistencias.map(p => 
                                  `${p.nombre} | ${obtenerResumenAsistencias(p).total}`
                              ).join('\n');

            const blob = new Blob([contenido], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Reporte_Asistencias_Cuadrilla.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // Inicializaci√≥n de la p√°gina al cargar
        document.addEventListener('DOMContentLoaded', () => {
            renderizarDashboard();
            renderizarTabla();
        });
        btnDescargar.addEventListener('click', descargarPDF);
        
        // Cerrar modal al hacer clic fuera
        detalleModal.addEventListener('click', (e) => {
            if (e.target === detalleModal) {
                cerrarModal();
            }
        });
        
        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === "Escape" && detalleModal.classList.contains('show')) {
                cerrarModal();
            }
        });
    </script>

</body>
</html>
