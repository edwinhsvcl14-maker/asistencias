<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Control de Asistencia</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /*
        ========================================================== */
        /* Estilos CSS Base y Colores */
        /*
        ========================================================== */
        
        :root {
            --color-principal: #F5F5DC; 
            --color-secundario: #FAF0E6; 
            --color-acento: #A0522D; 
            --color-texto-oscuro: #3E2723; 
            --color-borde: #D2B48C; 
            --color-exito: #38761D; 
            --color-dispensa: #F7D600; 
            --color-peligro: #CC0000; 
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-secundario);
            color: var(--color-texto-oscuro);
        }

        .contenedor {
            width: 90%;
            max-width: 1200px;
            margin: 40px auto;
            background-color: var(--color-principal);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            padding: 30px;
        }
        
        header {
            display: flex;
            justify-content: space-between; 
            align-items: center; 
            padding-bottom: 20px;
            border-bottom: 3px solid var(--color-acento);
            margin-bottom: 30px;
        }

        .header-titulo h1 {
            color: var(--color-acento);
            font-size: 2.2em; 
            margin: 0;
        }
        
        .logo-espacio {
            width: 100px; 
            height: 100px;
            border: 2px dashed var(--color-borde);
            border-radius: 50%; 
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0; 
            padding: 5px;
            box-sizing: border-box;
            background-color: white; 
        }
        
        .logo-espacio img {
            width: 80%; 
            height: 80%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        /*
        ---------------------------------------------------------- */
        /* Estilos del Dashboard */
        /*
        ---------------------------------------------------------- */
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 40px;
            padding: 20px;
            border-radius: 8px;
            background-color: var(--color-secundario);
            border: 1px solid var(--color-borde);
        }

        .tarjeta-resumen {
            flex: 1 1 calc(33.33% - 20px); 
            min-width: 250px; 
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            text-align: center;
            border-left: 5px solid var(--color-acento);
            display: flex; 
            flex-direction: column;
            justify-content: space-between;
        }

        .tarjeta-resumen h3 {
            margin-top: 0;
            color: var(--color-acento);
            font-size: 1.1em;
            text-transform: uppercase;
        }
        
        .valor {
            font-size: 4em; 
            font-weight: bold;
            color: var(--color-exito);
            line-height: 1.1; 
            padding-top: 10px;
            padding-bottom: 15px;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 150px; 
            height: 150px; 
            margin: 10px auto 0 auto; 
        }
        
        /*
        ---------------------------------------------------------- */
        /* Estilos de la Tabla y Bot贸n de Detalle */
        /*
        ---------------------------------------------------------- */

        .tabla-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; border: 1px solid var(--color-borde); border-radius: 8px; overflow: hidden; }
        th, td { padding: 14px 18px; text-align: center; border-bottom: 1px solid var(--color-borde); border-right: 1px solid var(--color-borde); }
        .score-total { font-size: 1.2em; font-weight: bold; color: var(--color-acento); }
        .score-parcial { font-weight: bold; color: var(--color-texto-oscuro); }
        .asistio-bg { background-color: var(--color-exito); color: white; border-radius: 4px; padding: 3px 6px; } 
        .dispensa-bg { background-color: var(--color-dispensa); color: var(--color-texto-oscuro); border-radius: 4px; padding: 3px 6px; } 
        .falto-bg { background-color: var(--color-peligro); color: white; border-radius: 4px; padding: 3px 6px; } 
        .btn-detalle { background-color: var(--color-acento); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.3s; font-size: 0.9em; }

        /*
        ---------------------------------------------------------- */
        /* Estilos del Modal (Ajuste para el gr谩fico interno) */
        /*
        ---------------------------------------------------------- */

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: none; 
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease;
        }

        .modal-backdrop.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: white; color: var(--color-texto-oscuro);
            padding: 30px; padding-top: 50px; border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 90%; max-width: 700px;
            transform: scale(0.9); transition: transform 0.3s ease;
            position: relative; 
        }

        .modal-stats {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* Corregido: Limitar el tama帽o del contenedor del gr谩fico de barra */
        .modal-bar-chart-container {
            flex: 2;
            width: 100%;
            max-width: 400px; 
            height: 50px; 
            margin: 0;
            position: relative;
        }

        .close-btn {
            position: absolute; top: 10px; right: 15px;
            background: none; border: none; font-size: 2.5em; 
            line-height: 1; cursor: pointer; color: var(--color-acento);
            padding: 5px; transition: color 0.2s; z-index: 10; 
        }

        /*
        ---------------------------------------------------------- */
        /* Estilos del Bot贸n de Descarga */
        /*
        ---------------------------------------------------------- */
        #btnDescargarPDF {
            background-color: var(--color-acento); color: white; border: none;
            padding: 15px 30px; font-size: 1.1em; border-radius: 8px;
            cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease;
        }

        /*
        ========================================================== */
        /* MEDIA QUERIES (Responsive Design) */
        /* 
        ========================================================== */

        @media (max-width: 768px) {
            
            .tarjeta-resumen { flex: 1 1 100%; min-width: auto; }
            header { flex-direction: column; text-align: center; }

            /* Tabla principal se convierte en tarjetas apiladas */
            table { border: none; } thead { display: none; }
            tbody, tr { display: block; }
            
            tbody tr { margin-bottom: 20px; border: 1px solid var(--color-borde); border-radius: 8px; background-color: white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }

            td { display: block; text-align: right; border-bottom: 1px solid #eee; border-right: none; padding: 10px 15px; position: relative; }
            
            td::before { content: attr(data-label); position: absolute; left: 15px; font-weight: bold; color: var(--color-acento); text-align: left; }
            
            tbody tr td:first-child { text-align: left; font-size: 1.1em; font-weight: bold; color: var(--color-texto-oscuro); border-bottom: 2px solid var(--color-borde); }
            
            tbody tr td:first-child::before { content: ""; }
            
            tbody tr td:last-child { border-bottom: none; text-align: center; }
            
            /* Modal en m贸vil */
            .modal-content { width: 95%; margin: 10px; }
            .modal-stats { flex-direction: column; align-items: stretch; }
            
            /* Asegurar que en m贸vil el gr谩fico ocupe casi todo el ancho, pero no se desborde */
            .modal-bar-chart-container {
                max-width: 100%; 
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="contenedor fade-in">
        <header>
            <div class="logo-espacio" id="logoCuadrilla">
                <img id="logoImg" src="" alt="Logo de la Cuadrilla">
            </div>
            <div class="header-titulo">
                <h1 id="cuadrillaTitulo">Cargando Cuadrilla...</h1>
                <p>Listado detallado de participaci贸n en actividades.</p>
            </div>
            <div class="logo-espacio" style="visibility: hidden;"></div> 
        </header>

        <h2> Resumen de Puntuaci贸n</h2>
        <section class="dashboard">
            <div class="tarjeta-resumen">
                <h3>Total de Hermanos</h3>
                <div class="valor" id="totalHermanos">0</div>
                <p class="descripcion">Miembros activos en la lista.</p>
            </div>

            <div class="tarjeta-resumen">
                <h3>Promedio General</h3>
                <div class="chart-container">
                    <canvas id="chartPromedioGeneral"></canvas>
                </div>
            </div>

            <div class="tarjeta-resumen">
                <h3>Participaci贸n Misas</h3>
                <div class="chart-container">
                    <canvas id="chartPromedioMisas"></canvas>
                </div>
            </div>
        </section>
        
        <h2> Detalle de Puntuaci贸n</h2>
        <div class="tabla-responsive">
            <table id="tablaAsistencias">
                <thead>
                    <tr>
                        <th style="text-align: left;">Nombre y Apellido</th>
                        <th>Puntos Retiro</th> 
                        <th>Puntos Asambleas</th> 
                        <th>Puntos Jornadas</th> 
                        <th>PUNTUACIN TOTAL</th> 
                        <th>Acciones</th> 
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>

        <div class="pie-pagina">
            <button id="btnDescargarPDF">Descargar Reporte Detallado (Simulaci贸n)</button>
        </div>
    </div>
    
    <div id="detalleModal" class="modal-backdrop">
        <div class="modal-content">
            
            <button class="close-btn" onclick="cerrarModal()">&times;</button>

            <div class="modal-header">
                <h2 id="modalNombreHermano">Detalle de Puntuaci贸n</h2>
            </div>

            <div class="modal-body">
                
                <div class="modal-stats">
                    <div style="flex: 1;">
                        <p style="margin: 0; font-weight: bold; font-size: 1.1em;">Puntuaci贸n Individual</p>
                        <p style="margin: 5px 0 0 0;">(Puntos obtenidos / Puntos posibles)</p>
                    </div>
                    
                    <div class="modal-bar-chart-container">
                        <span id="porcentajeAsistenciaLabel" style="text-align: right; display: block; margin-bottom: 5px; font-weight: bold;"></span> 
                        <canvas id="chartAsistenciaIndividual"></canvas>
                    </div>
                </div>

                <table class="modal-detalle-tabla">
                    <thead>
                        <tr>
                            <th>Evento</th>
                            <th>Sub-Evento</th>
                            <th>Estado</th> 
                            <th>Puntuaci贸n</th> 
                        </tr>
                    </thead>
                    <tbody id="modalDetalleBody">
                    </tbody>
                </table>
            </div>

        </div>
    </div>
    <script>
        // ==========================================================
        // CONSTANTES Y DATOS DINMICOS
        // ==========================================================
        const PUNTOS = {
            ASISTIO: 1.0, DISPENSA: 0.5, FALTO: 0.0
        };
        
        const headerLabels = {
            'Nombre y Apellido': '', 'Puntos Retiro': 'Puntos Retiro',
            'Puntos Asambleas': 'Puntos Asambleas', 'Puntos Jornadas': 'Puntos Jornadas',
            'PUNTUACIN TOTAL': 'Puntuaci贸n Total', 'Acciones': '' 
        };

        const COLOR_ACCENT = getComputedStyle(document.documentElement).getPropertyValue('--color-acento').trim();
        const COLOR_SUCCESS = getComputedStyle(document.documentElement).getPropertyValue('--color-exito').trim();
        const COLOR_TEXT = getComputedStyle(document.documentElement).getPropertyValue('--color-texto-oscuro').trim();
        const COLOR_BG_CHART = '#E0E0E0'; 

        // --- Mapeo de datos (SIMULACIN DINMICA) ---
        const DATOS_SIMULADOS = {
            '1': [ // Datos para ?id=1 (Primera Cuadrilla)
                { id: 1, nombre: "ALVA ALVAREZ ALFONSO DE JESUS", eventos: { retiro: [{ nombre: "Misa Ago", estado: 'ASISTIO' }, { nombre: "Misa Set", estado: 'DISPENSA' }], asamblea: [{ nombre: "Asam May", estado: 'ASISTIO' }, { nombre: "Asam Oct", estado: 'ASISTIO' }], jornadas: [{ nombre: "Jornada 1", estado: 'FALTO' }] } },
                { id: 2, nombre: "AQUIJE VALDEZ WILLY HUDSON", eventos: { retiro: [{ nombre: "Misa Ago", estado: 'ASISTIO' }, { nombre: "Misa Set", estado: 'DISPENSA' }], asamblea: [{ nombre: "Asam May", estado: 'ASISTIO' }, { nombre: "Asam Oct", estado: 'FALTO' }], jornadas: [{ nombre: "Jornada 1", estado: 'DISPENSA' }] } },
                // ... m谩s 72 hermanos simulados
                ...Array.from({ length: 72 }, (_, i) => ({ id: i + 3, nombre: `HERMANO SIMULADO ${i + 3}`, eventos: { retiro: [{ nombre: "Misa Ago", estado: 'ASISTIO' }, { nombre: "Misa Set", estado: 'ASISTIO' }], asamblea: [{ nombre: "Asam May", estado: 'FALTO' }, { nombre: "Asam Oct", estado: 'DISPENSA' }], jornadas: [{ nombre: "Jornada 1", estado: 'FALTO' }] } }))
            ],
            // **ESTE ES EL ID POR DEFECTO REQUERIDO**
            '12': [ 
                { id: 101, nombre: "RAMIREZ PEREZ JULIO CESAR", eventos: { retiro: [{ nombre: "Misa Ago", estado: 'ASISTIO' }, { nombre: "Misa Set", estado: 'ASISTIO' }], asamblea: [{ nombre: "Asam May", estado: 'ASISTIO' }, { nombre: "Asam Oct", estado: 'ASISTIO' }], jornadas: [{ nombre: "Jornada 1", estado: 'ASISTIO' }] } },
                { id: 102, nombre: "QUISPE CHOQUE JUAN MIGUEL", eventos: { retiro: [{ nombre: "Misa Ago", estado: 'FALTO' }, { nombre: "Misa Set", estado: 'ASISTIO' }], asamblea: [{ nombre: "Asam May", estado: 'DISPENSA' }, { nombre: "Asam Oct", estado: 'FALTO' }], jornadas: [{ nombre: "Jornada 1", estado: 'DISPENSA' }] } },
            ],
            'gs': [ 
                { id: 201, nombre: "MORALES VERA MARIA DE LA PAZ", eventos: { retiro: [{ nombre: "Misa Ago", estado: 'ASISTIO' }], asamblea: [{ nombre: "Asam May", estado: 'ASISTIO' }], jornadas: [] } },
            ],
            'gc': [
                 { id: 301, nombre: "SANCHEZ PEREZ TERESA", eventos: { retiro: [{ nombre: "Misa 1", estado: 'ASISTIO' }], asamblea: [{ nombre: "Asam 1", estado: 'ASISTIO' }], jornadas: [{ nombre: "Jornada 1", estado: 'ASISTIO' }] } },
            ]
        };
        // ---------------------------------------------

        let datosAsistencias = []; 
        let chartPromedioGeneral, chartPromedioMisas, chartAsistenciaIndividual;
        const tablaBody = document.querySelector('#tablaAsistencias tbody');
        const detalleModal = document.getElementById('detalleModal');
        const modalDetalleBody = document.getElementById('modalDetalleBody');
        const porcentajeLabel = document.getElementById('porcentajeAsistenciaLabel'); 
        
        // ==========================================================
        // FUNCIONES DE UTILIDAD Y MAPPING
        // ==========================================================

        function obtenerPuntuacion(estado) { return PUNTOS[estado] || 0.0; }
        
        function obtenerTextoEstado(estado) {
            switch (estado) {
                case 'ASISTIO': return { texto: 'Asisti贸', clase: 'asistio-bg' };
                case 'DISPENSA': return { texto: 'Dispensa', clase: 'dispensa-bg' };
                case 'FALTO': return { texto: 'Falt贸', clase: 'falto-bg' };
                default: return { texto: 'N/A', clase: '' };
            }
        }
        
        function getOrdinal(n) {
            const ordinals = ['Primera', 'Segunda', 'Tercera', 'Cuarta', 'Quinta', 'Sexta', 'S茅ptima', 'Octava', 'Novena', 'D茅cima', 'D茅cima Primera', 'D茅cima Segunda', 'D茅cima Tercera', 'D茅cima Cuarta', 'D茅cima Quinta', 'D茅cima Sexta', 'D茅cima S茅ptima', 'D茅cima Octava', 'D茅cima Novena', 'Vig茅sima'];
            return ordinals[n - 1] || `Cuadrilla ${n}`;
        }
        
        function loadHeader(id) {
            const titleElement = document.getElementById('cuadrillaTitulo');
            const logoElement = document.getElementById('logoImg');
            const pageTitleElement = document.getElementById('pageTitle');
            let cuadrillaTitle = '';
            let logoFileName = '';

            if (id >= 1 && id <= 20) {
                const number = parseInt(id);
                const ordinal = getOrdinal(number);
                cuadrillaTitle = `Control de Asistencia ${ordinal} Cuadrilla`;
                logoFileName = `logo_${id}cuadrilla.png`;
            } else if (id === 'gs') {
                cuadrillaTitle = 'Control de Asistencia Grupo de Sahumadoras';
                logoFileName = 'logo_gs.png';
            } else if (id === 'gc') {
                cuadrillaTitle = 'Control de Asistencia Grupo de Cantoras';
                logoFileName = 'logo_gc.png';
            } else {
                // Este caso no deber铆a ocurrir si se usa el default '12' correctamente
                cuadrillaTitle = `Error: ID '${id}' no reconocido`;
            }
            
            titleElement.textContent = cuadrillaTitle;
            pageTitleElement.textContent = cuadrillaTitle;
            logoElement.src = `https://edwinhsvcl14-maker.github.io/asistencias/${logoFileName}`; 
            logoElement.alt = cuadrillaTitle;
        }

        function obtenerResumenPuntos(hermano) {
            let resumen = { retiro: 0, asamblea: 0, jornadas: 0, total: 0, totalEventos: 0 };
            
            Object.keys(hermano.eventos).forEach(tipo => {
                hermano.eventos[tipo].forEach(evento => {
                    const puntos = obtenerPuntuacion(evento.estado);
                    resumen[tipo] += puntos;
                    resumen.total += puntos;
                    resumen.totalEventos += 1;
                });
            });
            
            resumen.retiro = parseFloat(resumen.retiro.toFixed(1));
            resumen.asamblea = parseFloat(resumen.asamblea.toFixed(1));
            resumen.jornadas = parseFloat(resumen.jornadas.toFixed(1));
            resumen.total = parseFloat(resumen.total.toFixed(1));
            return resumen;
        }

        // ==========================================================
        // LGICA DE CHART.JS 
        // ==========================================================

        const centerTextDoughnutPlugin = {
            id: 'centerTextDoughnut',
            beforeDraw: function(chart) {
                if (chart.config.options.plugins.centerTextDoughnut) {
                    const {width, height, ctx} = chart;
                    ctx.restore();
                    const percentage = chart.data.datasets[0].data[0] !== undefined ? chart.data.datasets[0].data[0].toFixed(1) : '0.0';
                    const fontSize = (height / 120).toFixed(2);
                    ctx.font = `bold ${fontSize}em 'Georgia', serif`;
                    ctx.textBaseline = "middle";
                    const text = `${percentage}%`;
                    const textX = Math.round((width - ctx.measureText(text).width) / 2);
                    const textY = height / 2;
                    ctx.fillStyle = COLOR_TEXT; 
                    ctx.fillText(text, textX, textY);
                    ctx.save();
                }
            }
        };
        Chart.register(centerTextDoughnutPlugin);

        function calcularEstadisticas() {
            const totalHermanos = datosAsistencias.length;
            if (totalHermanos === 0) {
                return { totalHermanos: 0, promedioGeneral: 0, promedioMisas: 0, numeroTotalEventos: 0 };
            }

            let totalMisasAsistidasPuntos = 0;
            let sumaTotalPuntosEventosIndividuales = 0; 
            
            const eventosPlantilla = datosAsistencias[0].eventos;
            let numeroTotalEventos = 0;
            let numMisas = 0;
            Object.keys(eventosPlantilla).forEach(tipo => {
                numeroTotalEventos += eventosPlantilla[tipo].length;
                if (tipo === 'retiro') {
                    numMisas = eventosPlantilla[tipo].length;
                }
            });
            
            if (numeroTotalEventos === 0) {
                return { totalHermanos, promedioGeneral: 0, promedioMisas: 0, numeroTotalEventos: 0 };
            }


            datosAsistencias.forEach(persona => {
                const resumen = obtenerResumenPuntos(persona);
                sumaTotalPuntosEventosIndividuales += resumen.total;
                totalMisasAsistidasPuntos += resumen.retiro;
            });

            // Promedio General
            const totalPuntosPosiblesEnTodosLosEventos = totalHermanos * numeroTotalEventos * PUNTOS.ASISTIO;
            const promedioGeneralPorcentaje = (sumaTotalPuntosEventosIndividuales / totalPuntosPosiblesEnTodosLosEventos) * 100;

            // Promedio Misas
            const promedioMisasPosibles = totalHermanos * numMisas * PUNTOS.ASISTIO;
            const promedioMisasPorcentaje = (promedioMisasPosibles === 0) ? 0 : (totalMisasAsistidasPuntos / promedioMisasPosibles) * 100;

            return {
                totalHermanos,
                promedioGeneral: parseFloat(promedioGeneralPorcentaje.toFixed(1)),
                promedioMisas: parseFloat(promedioMisasPorcentaje.toFixed(1)),
                numeroTotalEventos
            };
        }

        function renderizarDashboard() {
            const stats = calcularEstadisticas();
            document.getElementById('totalHermanos').textContent = stats.totalHermanos;

            // Gr谩fico de Promedio General
            const ctxGeneral = document.getElementById('chartPromedioGeneral').getContext('2d');
            if (chartPromedioGeneral) chartPromedioGeneral.destroy();
            chartPromedioGeneral = new Chart(ctxGeneral, {
                type: 'doughnut', data: { datasets: [{ data: [stats.promedioGeneral, 100 - stats.promedioGeneral], backgroundColor: [COLOR_SUCCESS, COLOR_BG_CHART], hoverOffset: 4 }]},
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%',
                plugins: { legend: { display: false }, tooltip: { enabled: true }, centerTextDoughnut: true }, animation: { animateRotate: true, animateScale: true } }
            });

            // Gr谩fico de Promedio Misas
            const ctxMisas = document.getElementById('chartPromedioMisas').getContext('2d');
            if (chartPromedioMisas) chartPromedioMisas.destroy();
            chartPromedioMisas = new Chart(ctxMisas, {
                type: 'doughnut', data: { datasets: [{ data: [stats.promedioMisas, 100 - stats.promedioMisas], backgroundColor: [COLOR_ACCENT, COLOR_BG_CHART], hoverOffset: 4 }]},
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%',
                plugins: { legend: { display: false }, tooltip: { enabled: true }, centerTextDoughnut: true }, animation: { animateRotate: true, animateScale: true } }
            });
        }
        
        function renderizarTabla() {
            tablaBody.innerHTML = ''; 
            const headers = ['Nombre y Apellido', 'Puntos Retiro', 'Puntos Asambleas', 'Puntos Jornadas', 'PUNTUACIN TOTAL', 'Acciones'];

            datosAsistencias.forEach(persona => {
                const resumen = obtenerResumenPuntos(persona);
                const fila = document.createElement('tr');
                
                // Nombre
                const celdaNombre = document.createElement('td');
                celdaNombre.textContent = persona.nombre;
                celdaNombre.style.textAlign = 'left'; 
                celdaNombre.setAttribute('data-label', headerLabels[headers[0]]); 
                fila.appendChild(celdaNombre);

                // Puntos Retiro
                let celdaRetiro = document.createElement('td');
                celdaRetiro.textContent = resumen.retiro.toFixed(1);
                celdaRetiro.classList.add('score-parcial');
                celdaRetiro.setAttribute('data-label', headerLabels[headers[1]]); 
                fila.appendChild(celdaRetiro);
                
                // Puntos Asamblea
                let celdaAsamblea = document.createElement('td');
                celdaAsamblea.textContent = resumen.asamblea.toFixed(1);
                celdaAsamblea.classList.add('score-parcial');
                celdaAsamblea.setAttribute('data-label', headerLabels[headers[2]]); 
                fila.appendChild(celdaAsamblea);

                // Puntos Jornada
                let celdaJornada = document.createElement('td');
                celdaJornada.textContent = resumen.jornadas.toFixed(1);
                celdaJornada.classList.add('score-parcial');
                celdaJornada.setAttribute('data-label', headerLabels[headers[3]]); 
                fila.appendChild(celdaJornada);

                // Total
                const celdaTotal = document.createElement('td');
                celdaTotal.textContent = resumen.total.toFixed(1);
                celdaTotal.classList.add('score-total');
                celdaTotal.setAttribute('data-label', headerLabels[headers[4]]); 
                fila.appendChild(celdaTotal);
                
                // Acci贸n
                const celdaAccion = document.createElement('td');
                const btnDetalle = document.createElement('button');
                btnDetalle.textContent = 'Ver Detalle';
                btnDetalle.classList.add('btn-detalle');
                btnDetalle.onclick = () => abrirModal(persona.id);
                celdaAccion.appendChild(btnDetalle);
                celdaAccion.setAttribute('data-label', headerLabels[headers[5]]); 
                fila.appendChild(celdaAccion);

                tablaBody.appendChild(fila);
            });
        }

        // ==========================================================
        // LGICA DEL MODAL
        // ==========================================================

        function abrirModal(idHermano) {
            const hermano = datosAsistencias.find(p => p.id === idHermano);
            if (!hermano) return;

            document.getElementById('modalNombreHermano').textContent = `Detalle de Puntuaci贸n: ${hermano.nombre}`;
            modalDetalleBody.innerHTML = '';
            
            let puntosObtenidos = 0;
            let puntosPosibles = 0;
            
            Object.keys(hermano.eventos).forEach(tipo => {
                const tipoDisplay = tipo.charAt(0).toUpperCase() + tipo.slice(1);
                hermano.eventos[tipo].forEach(evento => {
                    const puntos = obtenerPuntuacion(evento.estado);
                    const estadoDetalle = obtenerTextoEstado(evento.estado);
                    
                    puntosObtenidos += puntos;
                    puntosPosibles += PUNTOS.ASISTIO; 
                    
                    const fila = document.createElement('tr');
                    
                    const celdaTipo = document.createElement('td');
                    celdaTipo.textContent = tipoDisplay;
                    
                    const celdaNombre = document.createElement('td');
                    celdaNombre.textContent = evento.nombre;

                    const celdaEstado = document.createElement('td');
                    const spanEstado = document.createElement('span');
                    spanEstado.textContent = estadoDetalle.texto;
                    spanEstado.className = estadoDetalle.clase;
                    celdaEstado.appendChild(spanEstado);
                    
                    const celdaPuntuacion = document.createElement('td');
                    celdaPuntuacion.textContent = puntos.toFixed(1); 
                    
                    fila.appendChild(celdaTipo); fila.appendChild(celdaNombre);
                    fila.appendChild(celdaEstado); fila.appendChild(celdaPuntuacion);
                    modalDetalleBody.appendChild(fila);
                });
            });
            
            puntosObtenidos = parseFloat(puntosObtenidos.toFixed(1));
            const porcentajePuntos = puntosPosibles === 0 ? 0 : (puntosObtenidos / puntosPosibles) * 100;
            
            porcentajeLabel.textContent = `${porcentajePuntos.toFixed(1)}% (${puntosObtenidos.toFixed(1)} / ${puntosPosibles.toFixed(1)} Puntos)`;
            
            detalleModal.style.display = 'flex'; 
            
            setTimeout(() => {
                detalleModal.classList.add('show');
                renderizarChartIndividual(porcentajePuntos);
            }, 50); 
        }

        function cerrarModal() {
            detalleModal.classList.remove('show');
            setTimeout(() => detalleModal.style.display = 'none', 300); 
            
            if (chartAsistenciaIndividual) {
                chartAsistenciaIndividual.destroy();
                chartAsistenciaIndividual = null;
            }
        }
        
        function renderizarChartIndividual(porcentaje) {
            const ctxIndividual = document.getElementById('chartAsistenciaIndividual').getContext('2d');
            
            if (chartAsistenciaIndividual) {
                chartAsistenciaIndividual.destroy();
            }

            chartAsistenciaIndividual = new Chart(ctxIndividual, {
                type: 'bar',
                data: {
                    labels: ['Puntuaci贸n'],
                    datasets: [{
                        data: [porcentaje, 100 - porcentaje], 
                        backgroundColor: [COLOR_SUCCESS, COLOR_BG_CHART], 
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            max: 100, 
                            display: false, 
                        },
                        y: {
                            stacked: true,
                            display: false, 
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    layout: {
                        padding: { top: 0, bottom: 0 }
                    }
                }
            });
        }
        
        // ==========================================================
        // FUNCIN DE INICIALIZACIN CON LGICA DE ID POR DEFECTO
        // ==========================================================

        function inicializar() {
            const urlParams = new URLSearchParams(window.location.search);
            let idCuadrilla = urlParams.get('id');

            // LGICA CLAVE: Si no hay ID o si el ID en la URL no tiene datos, USAR '12'.
            if (!idCuadrilla || !DATOS_SIMULADOS[idCuadrilla]) {
                idCuadrilla = '12'; 
            }
            
            datosAsistencias = DATOS_SIMULADOS[idCuadrilla];

            if (!datosAsistencias) {
                // Este bloque maneja un caso de error si el ID por defecto no tuviera datos.
                document.getElementById('cuadrillaTitulo').textContent = `Error: ID de cuadrilla no encontrado. (ID usado: ${idCuadrilla})`;
                datosAsistencias = []; 
            } else {
                loadHeader(idCuadrilla);
            }
            
            renderizarDashboard();
            renderizarTabla();
        }

        // Ejecutar la funci贸n de inicializaci贸n al cargar la p谩gina
        window.onload = inicializar;

    </script>
</body>
</html>
